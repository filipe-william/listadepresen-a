<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Confirma√ß√£o - Anivers√°rio da J√∫lia</title>
<style>
  :root{
    --bg: #fff4fb;
    --card:#fff;
    --accent:#ff6fb8;
    --accent-2:#ff9ccf;
    --muted:#7a7a7a;
    --shadow: 0 6px 18px rgba(255,111,184,0.12);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{ background: linear-gradient(180deg,var(--bg),#ffeef9); margin:0; padding:20px; color:#333; }
  .wrap{ max-width:980px; margin:12px auto; }
  header{ display:flex; align-items:center; gap:16px; }
  .logo{ width:72px; height:72px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; box-shadow:var(--shadow); }
  h1{ margin:0; font-size:20px; }
  p.lead{ margin:6px 0 20px 0; color:var(--muted); }
  .card{ background:var(--card); border-radius:14px; padding:18px; box-shadow:var(--shadow); }
  .searchRow{ display:flex; gap:10px; margin-bottom:12px; }
  input[type="search"]{ flex:1; padding:12px 14px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); font-size:15px; }
  .list{ margin-top:8px; max-height:360px; overflow:auto; padding-right:6px; }
  .item{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.03); }
  .meta{ font-size:13px; color:var(--muted); }
  .confirmBox{ display:flex; gap:8px; align-items:center; }
  .btn{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; padding:8px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
  .msg{ margin-top:10px; padding:10px; border-radius:10px; color:#fff; background:linear-gradient(90deg,#28a745,#2ecc71); display:inline-block; }
  .admin{ margin-top:18px; display:flex; gap:8px; align-items:center; }
  .admin input{ padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); }
  .adminView{ margin-top:12px; display:none; }
  table{ width:100%; border-collapse:collapse; margin-top:8px; }
  th,td{ text-align:left; padding:10px; border-bottom:1px solid rgba(0,0,0,0.04); }
  .badge{ padding:6px 8px; border-radius:8px; background:linear-gradient(90deg,#fff0f9,#ffe6f6); color:var(--accent); font-weight:700; }
  .small{ font-size:13px; color:var(--muted); }
  .confirmSection{ margin-top:16px; display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .confirmBtn{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; padding:14px 24px; border-radius:10px; border:0; cursor:pointer; font-weight:700; font-size:16px; box-shadow:var(--shadow); }
  .confirmBtn:disabled{ opacity:0.5; cursor:not-allowed; }
  .counter{ font-size:15px; color:var(--muted); }
  .counter strong{ color:var(--accent); font-size:18px; }
  footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center; }
  @media(max-width:600px){ .searchRow{ flex-direction:column; } .logo{ width:60px;height:60px; } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">J</div>
      <div>
        <h1>Confirma√ß√£o de presen√ßa ‚Äî J√∫lia üéÄ</h1>
        <p class="lead">Procure seu nome, marque a caixinha e confirme sua presen√ßa. Simples e direto.</p>
      </div>
    </header>

    <section class="card" id="app">
      <div class="searchRow">
        <input id="search" type="search" placeholder="Digite seu nome (ex.: Ana, Filipe)..." autocomplete="off" />
        <button class="btn" id="clearBtn" type="button">Limpar</button>
      </div>

      <div class="list" id="list"></div>

      <div class="confirmSection">
        <button class="confirmBtn" id="confirmBtn" disabled>Confirmar presen√ßa</button>
        <div class="counter" id="counter">Nenhum nome selecionado</div>
      </div>

      <div id="messageArea"></div>

      <div class="admin card" style="margin-top:16px;">
        <input id="adminPass" type="password" placeholder="Senha do administrador" />
        <button id="adminBtn" class="btn">Entrar (Admin)</button>
        <button id="openConsoleBtn" class="btn" style="background:transparent;color:var(--accent);border:1px solid var(--accent);">Ver no Firebase</button>
      </div>

      <div class="adminView card" id="adminView">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><strong>Lista de confirmados</strong> <span class="small"> (em tempo real)</span></div>
          <div><button id="logoutAdmin" class="btn" style="background:transparent;color:var(--accent);border:1px solid var(--accent);">Sair</button></div>
        </div>
        <table id="confirmedTable">
          <thead><tr><th>Nome</th><th>Fam√≠lia / Grupo</th><th>Quando</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>
      Criado por Felps ‚Ä¢ Anivers√°rio da J√∫lia
    </footer>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBzFOEslYaHMU-4qA9KkVDVN34iGnSLDs8",
      authDomain: "confirmar-presenca-b89b4.firebaseapp.com",
      projectId: "confirmar-presenca-b89b4",
      storageBucket: "confirmar-presenca-b89b4.firebasestorage.app",
      messagingSenderId: "695843772901",
      appId: "1:695843772901:web:9c5208f3b076a52224370c",
      measurementId: "G-0ZGXW8XXN7"
    };

    const ADMIN_PASSWORD = "anivers√°rio da J√∫lia";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const people = [
      { family: "Aldeci e fam√≠lia", name: "Aldeci" },
      { family: "Aldeci e fam√≠lia", name: "La√≠s" },
      { family: "Aldeci e fam√≠lia", name: "Lara" },
      { family: "Analice e fam√≠lia", name: "Analice" },
      { family: "Analice e fam√≠lia", name: "Ana J√∫lia" },
      { family: "Analice e fam√≠lia", name: "Gustavo" },
      { family: "Analice e fam√≠lia", name: "Mailson" },
      { family: "Andr√© e fam√≠lia", name: "Andr√©" },
      { family: "Andr√© e fam√≠lia", name: "Gabriela" },
      { family: "Andr√©ia Lima", name: "Andr√©ia" },
      { family: "Ane Daniele e fam√≠lia", name: "Ane" },
      { family: "Ane Daniele e fam√≠lia", name: "Ana Lu√≠za" },
      { family: "Ane Daniele e fam√≠lia", name: "Duda" },
      { family: "Ane Daniele e fam√≠lia", name: "Rog√©rio" },
      { family: "Ane Daniele e fam√≠lia", name: "Valentina" },
      { family: "Branca e fam√≠lia", name: "Branca" },
      { family: "Branca e fam√≠lia", name: "Josimar" },
      { family: "Branca e fam√≠lia", name: "V√¥" },
      { family: "Branca e fam√≠lia", name: "Rian" },
      { family: "Carol e fam√≠lia", name: "Ant√¥nio Marcos" },
      { family: "Carol e fam√≠lia", name: "Carol" },
      { family: "Carol e fam√≠lia", name: "Gabi" },
      { family: "Carol e fam√≠lia", name: "Stela" },
      { family: "Cirley e Willian", name: "Cirley" },
      { family: "Cirley e Willian", name: "Willian Daniel" },
      { family: "Comadre Ana e fam√≠lia", name: "Ana" },
      { family: "Comadre Ana e fam√≠lia", name: "Luiz Carlos" },
      { family: "Comadre J√¥ e fam√≠lia", name: "Ant√¥nio" },
      { family: "Comadre J√¥ e fam√≠lia", name: "J√¥" },
      { family: "Comadre J√¥ e fam√≠lia", name: "Rafael" },
      { family: "Comadre Marta e fam√≠lia", name: "Breno" },
      { family: "Comadre Marta e fam√≠lia", name: "Magelo" },
      { family: "Comadre Marta e fam√≠lia", name: "Marta" },
      { family: "Dona Maria e Sr Carlinhos", name: "Dona Maria" },
      { family: "Dona Maria e Sr Carlinhos", name: "Carlinhos" },
      { family: "Dona Rosa e Waldenia", name: "Dona Rosa" },
      { family: "Dona Rosa e Waldenia", name: "Waldenia" },
      { family: "Duda e fam√≠lia", name: "Ana Carolina" },
      { family: "Duda e fam√≠lia", name: "Duda" },
      { family: "Duda e fam√≠lia", name: "Fabiana Ariai" },
      { family: "Duda e fam√≠lia", name: "Maria Helena" },
      { family: "Duda e fam√≠lia", name: "Maria Luiza" },
      { family: "Duda e fam√≠lia", name: "Petre Ariani" },
      { family: "Elza e Z√©", name: "Elza" },
      { family: "Elza e Z√©", name: "Z√©" },
      { family: "Eleida e fam√≠lia", name: "Cl√°udio" },
      { family: "Eleida e fam√≠lia", name: "Eleida" },
      { family: "Eleida e fam√≠lia", name: "Sofhia" },
      { family: "Eleida e fam√≠lia", name: "Vict√≥ria" },
      { family: "Fl√°via e fam√≠lia", name: "Cibely" },
      { family: "Fl√°via e fam√≠lia", name: "Fl√°via" },
      { family: "Fl√°via e fam√≠lia", name: "Giovana" },
      { family: "Fl√°via e fam√≠lia", name: "M√°rcio" },
      { family: "Gabriel Gabigol", name: "Gabriel" },
      { family: "Glac√©lia e fam√≠lia", name: "Glac√©lia" },
      { family: "Glac√©lia e fam√≠lia", name: "Guilherme" },
      { family: "Glac√©lia e fam√≠lia", name: "Wagner" },
      { family: "J√©ssica e fam√≠lia", name: "J√©ssica" },
      { family: "J√©ssica e fam√≠lia", name: "Rafael" },
      { family: "J√©ssica e fam√≠lia", name: "Gabi" },
      { family: "Jo√£o Matheus e fam√≠lia", name: "Jo√£o" },
      { family: "Jo√£o Matheus e fam√≠lia", name: "Let√≠cia" },
      { family: "Joyce e fam√≠lia", name: "Joyce" },
      { family: "Joyce e fam√≠lia", name: "Diego" },
      { family: "Joyce e fam√≠lia", name: "Jo√£o Pedro" },
      { family: "Jeniffer e fam√≠lia", name: "Filipe" },
      { family: "Jeniffer e fam√≠lia", name: "Jeniffer" },
      { family: "Jeniffer e fam√≠lia", name: "Lu√≠sa" },
      { family: "Jeniffer e fam√≠lia", name: "Tiago" },
      { family: "Jucelina e J√∫lio", name: "Jucelina" },
      { family: "Jucelina e J√∫lio", name: "J√∫lio" },
      { family: "Juliana e fam√≠lia", name: "Dimitri" },
      { family: "Juliana e fam√≠lia", name: "Heitor" },
      { family: "Juliana e fam√≠lia", name: "Helena" },
      { family: "Juliana e fam√≠lia", name: "Juliana" },
      { family: "Juliana e fam√≠lia", name: "Panteles" },
      { family: "Juliana e fam√≠lia", name: "Marina" },
      { family: "Karine e fam√≠lia", name: "Geraldinho" },
      { family: "Karine e fam√≠lia", name: "Gustavo" },
      { family: "Karine e fam√≠lia", name: "Karine" },
      { family: "Karine e fam√≠lia", name: "Lu√≠sa" },
      { family: "Leidiane e Juju", name: "Juju" },
      { family: "Leidiane e Juju", name: "Leidiane" },
      { family: "Leila e fam√≠lia", name: "Donizete" },
      { family: "Leila e fam√≠lia", name: "Isabela" },
      { family: "Leila e fam√≠lia", name: "Leila" },
      { family: "Leila e fam√≠lia", name: "Ti√£o" },
      { family: "Lene e fam√≠lia", name: "Lene" },
      { family: "Lene e fam√≠lia", name: "Tio Willian" },
      { family: "Lidu√≠na e fam√≠lia", name: "Lidu√≠na" },
      { family: "Lidu√≠na e fam√≠lia", name: "Ti√£o" },
      { family: "Lidu√≠na e fam√≠lia", name: "Juninho" },
      { family: "Lidu√≠na e fam√≠lia", name: "Aline" },
      { family: "Lidu√≠na e fam√≠lia", name: "Silvana" },
      { family: "Marcia e fam√≠lia", name: "Amanda" },
      { family: "Marcia e fam√≠lia", name: "Fernanda" },
      { family: "Marcia e fam√≠lia", name: "Geovana" },
      { family: "Marcia e fam√≠lia", name: "Henrique" },
      { family: "Marcia e fam√≠lia", name: "Marcia" },
      { family: "Marcia e fam√≠lia", name: "Roni" },
      { family: "Marley e fam√≠lia", name: "Marcio" },
      { family: "Marley e fam√≠lia", name: "Marley" },
      { family: "Marley e fam√≠lia", name: "Pedro" },
      { family: "Marli e fam√≠lia", name: "Ant√¥nio" },
      { family: "Marli e fam√≠lia", name: "Marli" },
      { family: "Marli e fam√≠lia", name: "Pedro Paulo" },
      { family: "Melina e fam√≠lia", name: "Bernardo" },
      { family: "Melina e fam√≠lia", name: "Ben√≠cio" },
      { family: "Melina e fam√≠lia", name: "Diogo" },
      { family: "Melina e fam√≠lia", name: "Melina" },
      { family: "Michelle e fam√≠lia", name: "Gesivan" },
      { family: "Michelle e fam√≠lia", name: "Lara" },
      { family: "Michelle e fam√≠lia", name: "Michelle" },
      { family: "Michelle e fam√≠lia", name: "Yasmim" },
      { family: "Paulinha e fam√≠lia", name: "Antonela" },
      { family: "Paulinha e fam√≠lia", name: "Laura" },
      { family: "Paulinha e fam√≠lia", name: "Paulinha" },
      { family: "Paulinha e fam√≠lia", name: "Roni" },
      { family: "Pedro Proc√≥pio e fam√≠lia", name: "Bruna" },
      { family: "Pedro Proc√≥pio e fam√≠lia", name: "√çtalo" },
      { family: "Pedro Proc√≥pio e fam√≠lia", name: "Pedro" },
      { family: "Pedro Proc√≥pio e fam√≠lia", name: "Titonha" },
      { family: "Pedro Proc√≥pio e fam√≠lia", name: "Salvina" },
      { family: "Priscila e fam√≠lia", name: "Jo√£o" },
      { family: "Priscila e fam√≠lia", name: "Kiko" },
      { family: "Priscila e fam√≠lia", name: "Priscila" },
      { family: "Rafael e D√©bora", name: "Rafael" },
      { family: "Rafael e D√©bora", name: "D√©bora" },
      { family: "Rita e fam√≠lia", name: "Rita" },
      { family: "Rita e fam√≠lia", name: "Viola" },
      { family: "Rita e fam√≠lia", name: "J√∫lia" },
      { family: "Rita e fam√≠lia", name: "Gabriela" },
      { family: "Rita e fam√≠lia", name: "Esposo da Gabi" },
      { family: "Tiago e Fam√≠lia", name: "Filipe" },
      { family: "Tiago e Fam√≠lia", name: "Jeniffer" },
      { family: "Tiago e Fam√≠lia", name: "Lu√≠sa" },
      { family: "Tiago e Fam√≠lia", name: "Tiago" },
      { family: "Tiago macarr√£o e fam√≠lia", name: "B√°rbara e o Beb√™" },
      { family: "Tiago macarr√£o e fam√≠lia", name: "Bernardo" },
      { family: "Tiago macarr√£o e fam√≠lia", name: "Sarah" },
      { family: "Tiago macarr√£o e fam√≠lia", name: "Tiago" },
      { family: "Tiago SESI e fam√≠lia", name: "Tiago" },
      { family: "Tiago SESI e fam√≠lia", name: "Larissa" },
      { family: "Salvina e fam√≠lia", name: "Bruna" },
      { family: "Salvina e fam√≠lia", name: "√çtalo" },
      { family: "Salvina e fam√≠lia", name: "Pedro" },
      { family: "Salvina e fam√≠lia", name: "Titonha" },
      { family: "Salvina e fam√≠lia", name: "Salvina" },
      { family: "Amigos da Julia", name: "Andrei" },
      { family: "Amigos da Julia", name: "Ana Luiza" },
      { family: "Amigos da Julia", name: "Sophia" },
      { family: "Amigos da Julia", name: "Jane" },
      { family: "Amigos da Julia", name: "Ana Clara" },
      { family: "Amigos da Julia", name: "Filipe William" },
      { family: "Amigos da Julia", name: "Isa Dora" },
      { family: "Amigos da Julia", name: "Clara Fleury" },
      { family: "Amigos da Julia", name: "Rafah" },
      { family: "Amigos da Julia", name: "Gabi Souza" },
      { family: "Amigos da Julia", name: "Gaby Cristina" },
      { family: "Amigos da Julia", name: "Lara" },
      { family: "Amigos da Julia", name: "Bella" },
      { family: "Amigos da Julia", name: "Anna" },
      { family: "Amigos da Julia", name: "Duda e Miguel" },
      { family: "Amigos da Julia", name: "Mayana" },
      { family: "Amigos da Julia", name: "Ana Maria" },
      { family: "Amigos da Julia", name: "Rafa" },
      { family: "Amigos da Julia", name: "Maria Eduarda Oliveira" },
      { family: "Amigos da Julia", name: "Geovanna" },
      { family: "Amigos da Julia", name: "Sarah" },
      { family: "Amigos da Julia", name: "Samuel Aguiar" },
      { family: "Amigos da Julia", name: "Pedro Aguiar" },
      { family: "Amigos da Julia", name: "Pedro Henrique" },
      { family: "Amigos da Julia", name: "Lucas Viana" },
      { family: "Amigos da Julia", name: "√çcaro" },
      { family: "Amigos da Julia", name: "Guilherme" },
      { family: "Amigos da Julia", name: "Let√≠cia" },
      { family: "Amigos da Julia", name: "Rebeca" },
      { family: "Amigos da Julia", name: "Eduardo Sousa" },
      { family: "Amigos da Julia", name: "Geovanna Benevinuto" },
      { family: "Amigos da Julia", name: "Laura Bicalho" },
      { family: "Amigos da Julia", name: "Isabella de Oliveira" },
      { family: "Amigos da Julia", name: "Giovanna Coutinho" },
      { family: "Amigos da Julia", name: "Gabriel Carvalho" },
      { family: "Amigos da Julia", name: "Viviane" },
      { family: "Amigos da Julia", name: "Filipe de Paula" },
      { family: "Amigos da Julia", name: "Arthur Fortes" },
      { family: "Amigos da Julia", name: "Bianca" },
      { family: "Amigos da Julia", name: "Victor" },
      { family: "Amigos da Julia", name: "Mari" },
      { family: "Amigos da Julia", name: "Enzo" },
      { family: "Amigos da Julia", name: "Alessandra" },
      { family: "Amigos da Julia", name: "Maria Gabriela" },
      { family: "Amigos da Julia", name: "Joao Victor Ata√≠de" },
      { family: "Amigos da Julia", name: "Isabella Brito" },
      { family: "Amigos da Julia", name: "Julia Sousa" },
      { family: "Amigos da Julia", name: "Matheus" },
      { family: "Amigos da Julia", name: "Let√≠cia" },
      { family: "Amigos da Julia", name: "Bia Ariadne" },
      { family: "Amigos da Julia", name: "Lucas Mendes" },
      { family: "Amigos da Julia", name: "Fernanda Costa" },
      { family: "Amigos da Julia", name: "Bruno Silva" },
    ];

    function sanitizeId(family, name){
      const raw = (family + "__" + name).toLowerCase();
      return raw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9_]/g, "_");
    }
    function formatDate(ts){
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }

    const $search = document.getElementById("search");
    const $list = document.getElementById("list");
    const $messageArea = document.getElementById("messageArea");
    const $clearBtn = document.getElementById("clearBtn");
    const $confirmBtn = document.getElementById("confirmBtn");
    const $counter = document.getElementById("counter");
    const $adminBtn = document.getElementById("adminBtn");
    const $adminPass = document.getElementById("adminPass");
    const $adminView = document.getElementById("adminView");
    const $confirmedTableBody = document.querySelector("#confirmedTable tbody");
    const $logoutAdmin = document.getElementById("logoutAdmin");
    const $openConsoleBtn = document.getElementById("openConsoleBtn");

    const selectedPeople = new Map();

    $openConsoleBtn.addEventListener("click", ()=> {
      const p = firebaseConfig.projectId;
      if(!p){ alert("Coloque seu firebaseConfig no c√≥digo primeiro."); return; }
      const url = `https://console.firebase.google.com/project/${p}/firestore/data`;
      window.open(url, "_blank");
    });

    function updateCounter(){
      const count = selectedPeople.size;
      if(count === 0){
        $counter.textContent = "Nenhum nome selecionado";
        $confirmBtn.disabled = true;
      } else if(count === 1){
        $counter.innerHTML = `<strong>1</strong> nome selecionado`;
        $confirmBtn.disabled = false;
      } else {
        $counter.innerHTML = `<strong>${count}</strong> nomes selecionados`;
        $confirmBtn.disabled = false;
      }
    }

    function renderList(filter = ""){
      $list.innerHTML = "";
      const q = filter.trim().toLowerCase();
      const filtered = people.filter(p => (p.name + " " + p.family).toLowerCase().includes(q));
      if(filtered.length === 0){
        $list.innerHTML = `<div class="small" style="padding:8px">Nenhum nome encontrado. Tente pesquisar por sobrenome ou fam√≠lia.</div>`;
        return;
      }
      filtered.forEach(p => {
        const id = sanitizeId(p.family, p.name);
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div>
            <div><strong>${p.name}</strong></div>
            <div class="meta">${p.family}</div>
          </div>
          <div class="confirmBox" id="cb_${id}">
            <label class="small" id="status_${id}">carregando...</label>
            <input type="checkbox" id="chk_${id}" style="width:20px;height:20px;border-radius:6px"/>
          </div>
        `;
        $list.appendChild(item);

        (async ()=>{
          try{
            const dRef = doc(db, "confirmations", id);
            const snap = await getDoc(dRef);
            const cb = document.getElementById(`chk_${id}`);
            const status = document.getElementById(`status_${id}`);
            if(snap.exists()){
              const data = snap.data();
              status.textContent = "Presen√ßa confirmada";
              status.className = "small";
              cb.checked = true;
              cb.disabled = true;
            } else {
              status.textContent = "";
              cb.checked = selectedPeople.has(id);
              cb.disabled = false;
              cb.addEventListener("change", (ev)=>{
                if(ev.target.checked){
                  selectedPeople.set(id, {name: p.name, family: p.family});
                } else {
                  selectedPeople.delete(id);
                }
                updateCounter();
              });
            }
          } catch(e){
            console.error(e);
            document.getElementById(`status_${id}`).textContent = "erro";
          }
        })();
      });
    }

    $search.addEventListener("input", ()=> renderList($search.value));
    $clearBtn.addEventListener("click", ()=> { $search.value = ""; renderList(); });

    $confirmBtn.addEventListener("click", async ()=> {
      if(selectedPeople.size === 0) return;
      
      $confirmBtn.disabled = true;
      $confirmBtn.textContent = "Confirmando...";
      
      try{
        const promises = [];
        for(const [id, person] of selectedPeople){
          const dRef = doc(db, "confirmations", id);
          promises.push(
            setDoc(dRef, {
              name: person.name,
              family: person.family,
              confirmed: true,
              ts: new Date()
            })
          );
        }
        
        await Promise.all(promises);
        
        const count = selectedPeople.size;
        selectedPeople.clear();
        updateCounter();
        
        if(count === 1){
          $messageArea.innerHTML = `<div class="msg">Presen√ßa confirmada! Obrigado üíñ</div>`;
        } else {
          $messageArea.innerHTML = `<div class="msg">${count} presen√ßas confirmadas! Obrigado üíñ</div>`;
        }
        
        setTimeout(()=> $messageArea.innerHTML = "", 4000);
        renderList($search.value);
        
      } catch(err){
        console.error(err);
        alert("Erro ao confirmar presen√ßas. Verifique se as regras do Firestore est√£o configuradas corretamente.");
      } finally {
        $confirmBtn.textContent = "Confirmar presen√ßa";
        $confirmBtn.disabled = selectedPeople.size === 0;
      }
    });

    let adminLogged = false;
    $adminBtn.addEventListener("click", () => {
      if($adminPass.value === ADMIN_PASSWORD){
        adminLogged = true;
        $adminView.style.display = "block";
        $adminPass.value = "";
        startAdminListener();
      } else {
        alert("Senha incorreta.");
      }
    });
    $logoutAdmin.addEventListener("click", ()=>{
      adminLogged = false;
      $adminView.style.display = "none";
      unsubscribeAdmin && unsubscribeAdmin();
      $confirmedTableBody.innerHTML = "";
    });

    let unsubscribeAdmin = null;
    function startAdminListener(){
      const coll = collection(db, "confirmations");
      const q = query(coll, orderBy("ts"));
      unsubscribeAdmin = onSnapshot(q, (snap)=>{
        $confirmedTableBody.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.family)}</td><td>${formatDate(d.ts)}</td>`;
          $confirmedTableBody.appendChild(tr);
        });
      }, err => {
        console.error("Erro admin listener", err);
        alert("Erro ao conectar com Firestore. Confira o firebaseConfig e regras do Firestore.");
      });
    }

    function escapeHtml(text){ return (text + "").replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    renderList();

  </script>
</body>
</html>